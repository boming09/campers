<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cp.campers.search.model.dao.SearchMapper">

	<resultMap id="searchCampMap" type="com.cp.campers.search.model.vo.SearchCamp">
		<id property="cNo" column="CAMP_NO" />
		<result property="cName" column="CAMP_NAME" />
		<result property="cAddress" column="CAMP_ADDRESS" />
		<result property="fileRoute" column="FILE_ROUTE" />
		<result property="fileName" column="FILE_NAME" />
		<result property="rCount" column="ROOM_COUNT" />
		<result property="maxGuest" column="MAX_GUEST" />
		<result property="minPrice" column="MIN_PRICE" />
		<result property="maxPrice" column="MAX_PRICE" />
	</resultMap>



	<select id="mainSearch" parameterType="hashmap" resultType="com.cp.campers.search.model.vo.SearchCamp">
		SELECT 
				C.CAMP_NO 
			  , C.CAMP_NAME 
			  , C.CAMP_ADDRESS 
			  , F.FILE_ROUTE 
			  , F.FILE_NAME 
			  , SUM(R.ROOM_COUNT) AS "ROOM_COUNT" 
			  , MAX(R.ROOM_MEMBER) AS "MAX_GUEST" 
			  , MIN(R.ROOM_PRICE) AS "MIN_PRICE"
			  , MAX(R.ROOM_PRICE) AS "MAX_PRICE"
		   FROM ROOM R 
		   JOIN RESERVE E ON R.ROOM_NO = E.ROOM_NO 
		   JOIN CAMP C ON R.CAMP_NO = C.CAMP_NO 
		   JOIN CAMP_FILE I ON C.CAMP_NO = I.CAMP_NO 
		   JOIN IMAGEFILE F ON I.FILE_NO = F.FILE_NO
		   JOIN CAMP_BUSINESS_TYPE T ON C.CAMP_NO = T.CAMP_NO
		   JOIN BUSINESS_TYPE B ON B.BUSINESS_NO = T.BUSINESS_NO 
		   WHERE C.CAMP_STATUS = 'Y' 
		   AND C.CAMP_ADDRESS LIKE '%' || #{area} || '%' 
		   AND R.ROOM_MEMBER &gt;= #{guest} 
		   AND E.CHECKIN NOT BETWEEN #{checkIn} AND #{checkOut}
		   AND F.FILE_STATUS = 'N' 
		   AND F.FILE_LEVEL = 1
		   AND REGEXP_LIKE (B.BUSINESS_TYPE, #{type})
		 GROUP BY C.CAMP_NO, C.CAMP_NAME, C.CAMP_ADDRESS, F.FILE_ROUTE, F.FILE_NAME 
		 ORDER BY C.CAMP_NAME DESC
	</select>



	<select id="campAllSearch" parameterType="com.cp.campers.search.model.vo.PageInfo" resultMap="searchCampMap">
		SELECT
        *
		FROM
			(
				SELECT 
                    ROWNUM AS NUM
                  , C.CAMP_NO 
                  , C.CAMP_NAME 
                  , C.CAMP_ADDRESS 
                  , F.FILE_ROUTE 
                  , F.FILE_NAME 
                  , SUM(R.ROOM_COUNT) AS "ROOM_COUNT"
                  , MAX(R.ROOM_MEMBER) AS "MAX_GUEST" 
                  , MIN(R.ROOM_PRICE) AS "MIN_PRICE"
                  , MAX(R.ROOM_PRICE) AS "MAX_PRICE" 
               FROM ROOM R 
               JOIN CAMP C ON R.CAMP_NO = C.CAMP_NO 
               JOIN CAMP_FILE I ON C.CAMP_NO = I.CAMP_NO
               JOIN IMAGEFILE F ON I.FILE_NO = F.FILE_NO 
              WHERE C.CAMP_STATUS = 'Y'
                AND F.FILE_STATUS = 'N' 
                AND F.FILE_LEVEL = 1 
              GROUP BY ROWNUM, C.CAMP_NO, C.CAMP_NAME, C.CAMP_ADDRESS, F.FILE_ROUTE, F.FILE_NAME 
              ORDER BY C.CAMP_NAME ASC
		 )
		WHERE NUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	
	<!-- 등록된 캠핑장 총 개수 구하기 -->
	<select id="campListCount" resultType="_int">
		SELECT
				COUNT(*) 
		   FROM CAMP 
		  WHERE CAMP_STATUS = 'Y'
	</select>
	
	
	<!-- 조건 검색된 캠핑장 총 개수 구하기 -->
	<select id="campFindCount" resultType="_int">
	SELECT
        	COUNT(CAMP_NO)
	   FROM (SELECT
				    C.CAMP_NO
				  , C.CAMP_NAME 
				  , C.CAMP_ADDRESS 
				  , F.FILE_ROUTE 
				  , F.FILE_NAME 
				  , SUM(R.ROOM_COUNT) AS "ROOM_COUNT"
				  , MAX(R.ROOM_MEMBER) AS "MAX_GUEST"
				  , MIN(R.ROOM_PRICE) AS "MIN_PRICE"
				  , MAX(R.ROOM_PRICE) AS "MAX_PRICE"
			   FROM ROOM R
			   JOIN CAMP C ON R.CAMP_NO = C.CAMP_NO 
			   JOIN CAMP_FILE I ON C.CAMP_NO = I.CAMP_NO 
			   JOIN IMAGEFILE F ON I.FILE_NO = F.FILE_NO
			   JOIN CAMP_BUSINESS_TYPE T ON C.CAMP_NO = T.CAMP_NO
			   JOIN BUSINESS_TYPE P ON P.BUSINESS_NO = T.BUSINESS_NO
			   JOIN CAMP_FACILITY Y ON C.CAMP_NO = Y.CAMP_NO
               JOIN FACILITY L ON L.FACILITY_NO = Y.FACILITY_NO
			   WHERE C.CAMP_STATUS = 'Y'
			     AND F.FILE_STATUS = 'N'
			     AND C.CAMP_ADDRESS LIKE '%'||#{ sArea }||'%'
			     AND R.ROOM_MEMBER &gt;= #{ sGuest }
			    <if test="sName != null and sName != ''">
			     OR C.CAMP_NAME LIKE '%'||#{ sName }||'%'
			    </if>
			    <if test="sType != null and sType != ''">
			     OR P.BUSINESS_TYPE IN (#{ sType })
			    </if>
			     <if test="sFaci != null and sFaci != ''">
			     OR L.FACILITY_NAME IN (#{ sFaci })
			    </if>
			     <if test="sFloor != null and sFloor != ''">
			     OR R.ROOM_FLOOR IN (#{ sFloor })
			    </if>
			     GROUP BY C.CAMP_NO, C.CAMP_NAME, C.CAMP_ADDRESS, F.FILE_ROUTE, F.FILE_NAME, R.ROOM_MEMBER
           )
	</select>
	
	
	
	<select id="campFindSearch" parameterType="Map" resultMap="searchCampMap">
		SELECT *
		FROM (SELECT ROWNUM RNUM, A.*
		FROM (SELECT
				    C.CAMP_NO AS "CAMP_NO"
				  , C.CAMP_NAME AS "CAMP_NAME"
				  , SUBSTR(CAMP_ADDRESS, 0, INSTR(CAMP_ADDRESS, ' ', 1, 3)) AS "CAMP_ADDRESS"
				  , F.FILE_ROUTE AS "FILE_ROUTE"
				  , F.FILE_NAME AS "FILE_NAME"
				  , SUM(R.ROOM_COUNT) AS "ROOM_COUNT"
				  , MAX(R.ROOM_MEMBER) AS "MAX_GUEST"
				  , MIN(R.ROOM_PRICE) AS "MIN_PRICE"
				  , MAX(R.ROOM_PRICE) AS "MAX_PRICE"
			   FROM ROOM R
			   JOIN CAMP C ON R.CAMP_NO = C.CAMP_NO 
			   JOIN CAMP_FILE I ON C.CAMP_NO = I.CAMP_NO 
			   JOIN IMAGEFILE F ON I.FILE_NO = F.FILE_NO
			   JOIN CAMP_BUSINESS_TYPE T ON C.CAMP_NO = T.CAMP_NO
			   JOIN BUSINESS_TYPE P ON P.BUSINESS_NO = T.BUSINESS_NO
			   JOIN CAMP_FACILITY Y ON C.CAMP_NO = Y.CAMP_NO
               JOIN FACILITY L ON L.FACILITY_NO = Y.FACILITY_NO
			   WHERE C.CAMP_STATUS = 'Y' 
			    AND F.FILE_STATUS = 'N' 
			    AND F.FILE_LEVEL = 1
			    AND C.CAMP_ADDRESS LIKE '%'||#{ fc.sArea }||'%' 
			    AND R.ROOM_MEMBER &gt;= #{ fc.sGuest } 
			    <if test="fc.sName != null and fc.sName != ''">
			    OR C.CAMP_NAME LIKE '%'||#{ fc.sName }||'%'
			    </if>
			    <if test="fc.sType != null and fc.sType != ''">
			    OR P.BUSINESS_TYPE IN (#{ fc.sType })
			    </if>
			     <if test="fc.sFaci != null and fc.sFaci != ''">
			     OR L.FACILITY_NAME IN (#{ fc.sFaci })
			    </if>
			     <if test="fc.sFloor != null and fc.sFloor != ''">
			     OR R.ROOM_FLOOR IN (#{ fc.sFloor })
			    </if>
			  GROUP BY C.CAMP_NO, C.CAMP_NAME, C.CAMP_ADDRESS, F.FILE_ROUTE, F.FILE_NAME, R.ROOM_MEMBER
			  ORDER BY C.CAMP_NAME ASC
			)A)
		WHERE ROWNUM BETWEEN #{ pi.startRow } AND #{ pi.endRow }
	</select>
	
	

</mapper>